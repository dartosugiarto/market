<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlayPal.ID</title>
  <meta name="description" content="Destinasi Utama Para Pecinta Game, Film & Musik">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --text:#1f2937; --muted:#6b7280;
      --surface:#f3f3f3; --border:#e5e7eb; --surface-hover:#e9e9e9;
      --primary:#5C80BC; --primary-hover:#4a6b9a;
      --maxw:700px; --radius:8px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#111827; --text:#f3f4f6; --muted:#9ca3af;
        --surface:#1f2937; --border:#374151; --surface-hover:#374151;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Inter',ui-sans-serif,-apple-system,system-ui,"Segoe UI",sans-serif;
      font-size:15px; line-height:1.5;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:var(--maxw); margin:0 auto; padding:32px 16px}

    /* HEADER */
    header{ position:relative; text-align:center; margin-bottom:24px; }
    header .logo{ height:50px; width:auto; margin-bottom:12px; }
    header h1{ margin:0 0 4px; font-size:clamp(24px,4vw,30px); font-weight:800; }
    header p{ margin:0; color:var(--muted); font-size:15px; }

    /* Mode badge */
    .mode-badge{
      display:inline-flex; align-items:center; gap:8px;
      margin-top:12px; padding:6px 10px; border:1px solid var(--border);
      background:var(--surface); border-radius:999px; font-size:12px; color:var(--muted);
    }
    .mode-dot{ width:8px; height:8px; border-radius:50%; background:var(--primary); }

    /* Burger Menu */
    .burger{
      position:absolute; top:16px; right:16px;
      width:28px; height:20px; cursor:pointer;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .burger span{ display:block; height:2px; width:100%; background:var(--text); border-radius:2px; transition:all .3s ease; }
    .burger.active span:nth-child(1){ transform:rotate(45deg) translate(5px,5px); }
    .burger.active span:nth-child(2){ opacity:0; }
    .burger.active span:nth-child(3){ transform:rotate(-45deg) translate(5px,-5px); }

    /* Dropdown Menu */
    .menu{
      position:absolute; top:48px; right:16px;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 4px 16px rgba(0,0,0,0.15);
      display:none; flex-direction:column;
      min-width:180px; overflow:hidden;
    }
    .menu .menu-btn{
      padding:12px 16px; border:0; background:transparent; text-align:left;
      color:var(--text); font-weight:600; font-size:14px; cursor:pointer;
      transition:background .2s ease;
    }
    .menu .menu-btn:hover{ background:var(--surface-hover); }
    .menu .menu-divider{ height:1px; background:var(--border); margin:4px 0; }

    /* Tools & list */
    .select-wrap{ position:relative; margin:20px 0; }
    .game-select{
      width:100%; padding:12px 16px; border:1px solid var(--border);
      background-color:var(--bg); color:var(--text); border-radius:var(--radius);
      font-size:15px; font-weight:600;
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 20 20'%3E%3Cpath d='M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; background-size:20px;
    }
    .tools{display:flex; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search-wrap{position:relative; flex:1 1 250px;}
    .search-wrap svg{ position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; color:var(--muted); }
    .tools input[type="search"]{
      width:100%; padding:8px 12px 8px 38px; border:1px solid var(--border);
      background:var(--bg); color:var(--text); border-radius:var(--radius); font-size:14px;
    }
    .tools .info{color:var(--muted); font-size:13px; font-weight:500; padding-left:12px;}

    .list-container{ display:flex; flex-direction:column; gap:8px; }
    .list-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; background:var(--surface); border-radius:var(--radius);
      text-decoration:none; color:inherit; transition:background-color .2s ease;
    }
    .list-item:hover{ background-color:var(--surface-hover); }
    .list-item .title{ font-size:14px; font-weight:500; color:var(--text); }
    .list-item .price{ font-size:14px; font-weight:600; color:var(--primary); }

    .empty, .err{ border:1px dashed var(--border); border-radius:var(--radius); padding:40px; text-align:center; color:var(--muted); font-size:14px; }
    .err{ border:1px solid #ef4444; background:#fef2f2; color:#b91c1c; display:none }
    @media (prefers-color-scheme: dark){ .err{background:#2a0c0c; color:#fca5a5; border-color:#7f1d1d} }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <img src="logo.png" alt="PlayPal.ID Logo" class="logo">
      <h1>PlayPal.ID</h1>
      <p>Destinasi Utama Para Pecinta Game, Film &amp; Musik</p>

      <!-- Burger menu -->
      <div class="burger" id="burger" aria-label="Menu" aria-expanded="false" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
      <nav class="menu" id="menu" aria-label="Navigasi tampilan">
        <button class="menu-btn" data-mode="katalog" type="button">Katalog</button>
        <button class="menu-btn" data-mode="preorder" type="button">Pre-Order</button>
        <div class="menu-divider"></div>
        <button class="menu-btn" id="closeMenu" type="button">Tutup</button>
      </nav>

      <div class="mode-badge" id="modeBadge" aria-live="polite">
        <span class="mode-dot" aria-hidden="true"></span>
        <span id="modeText">Mode: Katalog</span>
      </div>
    </header>

    <div class="select-wrap">
      <select id="game-select" class="game-select" aria-label="Pilih Kategori"></select>
    </div>

    <div class="tools">
      <div class="search-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.901l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"/></svg>
        <input id="search" type="search" placeholder="Cari item..." aria-label="Cari">
      </div>
      <span id="countInfo" class="info"></span>
    </div>

    <section id="list-container" class="list-container" aria-live="polite"></section>
    <section id="error" class="err"></section>

    <template id="itemTmpl">
      <a class="list-item" target="_blank" rel="noopener">
        <span class="title"></span>
        <span class="price"></span>
      </a>
    </template>
  </main>

  <script>
    // ========= KONFIG =========
    const SHEET_ID = '1B0XPR4uSvRzy9LfzWDjNjwAyMZVtJs6_Kk_r2fh7dTw';
    // Sheet3 = katalog normal, Sheet1 = preorder
    const SHEETS = {
      katalog : { name:'Sheet3' },
      preorder: { name:'Sheet1' } // <<-- sesuai permintaan: "sheet satu" sebagai Pre-Order
    };
    const WA_NUMBER   = '6285877001999';
    const WA_GREETING = '*Detail pesanan:*';

    // ========= MENU (burger) =========
    const burger = document.getElementById('burger');
    const menu = document.getElementById('menu');
    function setMenuOpen(open){
      burger.classList.toggle('active', open);
      menu.style.display = open ? 'flex' : 'none';
      burger.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    burger.addEventListener('click', () => setMenuOpen(menu.style.display !== 'flex'));
    document.getElementById('closeMenu').addEventListener('click', () => setMenuOpen(false));
    // Tutup menu saat klik di luar
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !burger.contains(e.target)) setMenuOpen(false);
    });

    // ========= UTIL / PARSER =========
    function prettyLabel(raw){ return String(raw||'').trim().replace(/\s+/g,' '); }
    const toIDR = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);
    const sheetUrl = (sheetName) =>
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;

    // Parser GViz kolom berpasangan (Judul | Harga)
    function parseGVizPairs(jsonText){
      const m = jsonText.match(/\{.*\}/s);
      if(!m) throw new Error('Response GViz tidak valid.');
      const obj = JSON.parse(m[0]);
      const table = obj.table || {}, rows = table.rows || [], cols = table.cols || [];
      const pairs = [];
      for(let i=0; i<cols.length; i+=2){
        const label = cols[i]?.label || '';
        if(label && cols[i+1]) pairs.push({ iTitle:i, iPrice:i+1, label });
      }
      const out = [];
      for(const r of rows){
        const c = r.c || [];
        for(const p of pairs){
          const title = c[p.iTitle]?.v != null ? String(c[p.iTitle].v).trim() : '';
          const priceRaw = c[p.iPrice]?.v;
          const price = priceRaw!=null && priceRaw!=='' ? Number(priceRaw) : NaN;
          if(title && !isNaN(price)){
            out.push({ catKey:p.label, catLabel:prettyLabel(p.label), title, price });
          }
        }
      }
      return out;
    }

    // ========= STATE =========
    const gameSelectEl = document.getElementById('game-select');
    const listEl = document.getElementById('list-container');
    const searchEl = document.getElementById('search');
    const countInfoEl = document.getElementById('countInfo');
    const itemTmpl = document.getElementById('itemTmpl');
    const errBox = document.getElementById('error');
    const modeText = document.getElementById('modeText');

    let MODE = 'katalog'; // 'katalog' | 'preorder'
    let DATA = { katalog:[], preorder:[] };
    let CATS = { katalog:[], preorder:[] };
    let activeCat = '';
    let query = '';

    function updateBadge(){
      modeText.textContent = 'Mode: ' + (MODE === 'preorder' ? 'Pre-Order' : 'Katalog');
    }

    function buildCatsFor(mode){
      const map = new Map();
      DATA[mode].forEach(it => { if(!map.has(it.catKey)) map.set(it.catKey, it.catLabel); });
      CATS[mode] = [...map].map(([key,label]) => ({key,label}));
    }

    function buildGameSelect(){
      gameSelectEl.innerHTML = '';
      CATS[MODE].forEach(c => {
        const option = document.createElement('option');
        option.value = c.key;
        option.textContent = c.label;
        gameSelectEl.appendChild(option);
      });
      activeCat = CATS[MODE][0]?.key || '';
    }

    function renderList(){
      const items = DATA[MODE].filter(x =>
        (activeCat ? x.catKey === activeCat : true) &&
        (query === '' || x.title.toLowerCase().includes(query) || String(x.price).includes(query))
      );
      listEl.innerHTML = '';
      if(items.length === 0){
        listEl.innerHTML = `<div class="empty">Tidak ada hasil ditemukan.</div>`;
        countInfoEl.textContent = '';
        return;
      }
      const fragment = document.createDocumentFragment();
      for(const it of items){
        const clone = itemTmpl.content.cloneNode(true);
        const link = clone.querySelector('.list-item');
        link.querySelector('.title').textContent = it.title;
        link.querySelector('.price').textContent = toIDR(it.price);
        const tipeLabel = MODE === 'preorder' ? 'Pre-Order' : 'Katalog';
        const text = `${WA_GREETING}\n› Tipe: ${tipeLabel}\n› Game: ${it.catLabel}\n› Item: ${it.title}\n› Harga: ${toIDR(it.price)}`;
        link.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
        fragment.appendChild(clone);
      }
      listEl.appendChild(fragment);
      countInfoEl.textContent = `${items.length} item`;
    }

    // ========= EVENT =========
    gameSelectEl.addEventListener('change', e => { activeCat = e.target.value; renderList(); });

    let debounceTimer;
    searchEl.addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        query = e.target.value.trim().toLowerCase();
        renderList();
      }, 150);
    });

    // Switch mode dari menu
    menu.querySelectorAll('.menu-btn[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => {
        const nextMode = btn.getAttribute('data-mode');
        if (MODE !== nextMode){
          MODE = nextMode;
          updateBadge();
          if (CATS[MODE].length === 0 && DATA[MODE].length === 0){
            // kalau belum ter-load, akan terisi saat loadAll resolve (sudah terjadi lebih dulu)
          }
          buildGameSelect();
          renderList();
        }
        setMenuOpen(false);
      });
    });

    // ========= LOAD =========
    async function loadSheet(sheetName){
      const res = await fetch(sheetUrl(sheetName), { cache:'no-store' });
      const txt = await res.text();
      return parseGVizPairs(txt);
    }

    async function loadAll(){
      try{
        errBox.style.display = 'none';
        const [dataKatalog, dataPre] = await Promise.all([
          loadSheet(SHEETS.katalog.name),
          loadSheet(SHEETS.preorder.name)
        ]);
        DATA.katalog = dataKatalog;
        DATA.preorder = dataPre;

        if (DATA.katalog.length === 0 && DATA.preorder.length === 0){
          throw new Error('Data kosong di kedua sheet atau format kolom tidak sesuai.');
        }

        buildCatsFor('katalog');
        buildCatsFor('preorder');

        // Default masuk ke Katalog, tapi kalau kosong, otomatis ke Pre-Order
        if (CATS.katalog.length === 0 && CATS.preorder.length > 0) MODE = 'preorder';

        updateBadge();
        buildGameSelect();
        renderList();
      }catch(err){
        errBox.style.display = 'block';
        errBox.textContent = `Gagal memuat data: ${err.message}`;
      }
    }
    loadAll();
  </script>
</body>
</html>
