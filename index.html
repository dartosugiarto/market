<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlayPal.ID</title>
  <meta name="description" content="Destinasi Utama Para Pecinta Game, Film & Musik">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root {
      /* Palet super flat premium */
      --primary-blue: #5C80BC;
      --primary-blue-rgb: 92, 128, 188;
      --bg: #f5f5f7;
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #86868b;
      --fill-primary: #ffffff;
      --fill-secondary: #f2f2f4;
      --fill-tertiary: #ebebee;
      --separator: #e5e5ea;

      --maxw: 1080px;
      --radius-large: 16px;
      --radius-medium: 12px;
      --radius-small: 10px;
      --transition-curve: cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Ikuti tema sistem (hapus blok ini jika mau always-light) */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --text-primary: #f5f5f7;
        --text-secondary: #9a9aa0;
        --text-tertiary: #7a7a80;
        --fill-primary: #111113;
        --fill-secondary: #18181a;
        --fill-tertiary: #202022;
        --separator: #2a2a2e;
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      letter-spacing: -0.01em;
    }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 48px 20px; }

    /* === HEADER === */
    header { text-align: center; margin-bottom: 16px; }
    .logo { height: 44px; width: auto; }
    header h1 { margin: 10px 0 0; font-size: clamp(26px, 3.5vw, 34px); font-weight: 700; letter-spacing: -0.02em; }
    header p { margin: 4px 0 0; color: var(--text-secondary); font-size: 16px; }

    /* === DROPDOWN MENU (Flyout) === */
    .menu {
      position: absolute; z-index: 100;
      right: 0; top: 52px; /* muncul tepat di bawah burger */
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(0, 0, 0, 0.04);
      border-radius: var(--radius-medium);
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      display: flex; flex-direction: column;
      min-width: 210px; overflow: clip;
      opacity: 0; transform: translateY(-6px) scale(0.98);
      transition: opacity 0.24s var(--transition-curve), transform 0.24s var(--transition-curve);
      pointer-events: none;
    }
    .menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    .menu-btn {
      padding: 12px 16px; border: 0; background: transparent; text-align: left;
      color: var(--text-primary); font-weight: 700; font-size: 15px; cursor: pointer; letter-spacing: -0.01em;
    }
    .menu-btn:hover { background: rgba(0, 0, 0, 0.04); }
    .menu-divider { height: 1px; background: var(--separator); margin: 6px 0; }
    @media (prefers-color-scheme: dark) {
      .menu { background: rgba(20, 20, 22, 0.72); border-color: rgba(255, 255, 255, 0.08); }
      .menu-btn:hover { background: rgba(255, 255, 255, 0.06); }
    }

    /* === VIEW: KATALOG === */
    #viewCatalog { display: block; }
    .controls-katalog {
      position: relative; /* agar flyout .menu bisa anchor ke sini */
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "select menu"
        "search search";
      gap: 10px;
      margin: 20px 0 14px;
    }
    .controls-katalog #custom-select-wrapper { grid-area: select; min-width: 0; }
    .controls-katalog .burger { grid-area: menu; }
    .controls-katalog .search-wrap { grid-area: search; }

    /* CUSTOM SELECT (kategori game) â€” compact */
    .custom-select-wrapper { position: relative; }
    .custom-select-btn {
      width: 100%; height: 44px; padding: 10px 14px;
      background: var(--fill-primary); border: 1px solid var(--separator); border-radius: var(--radius-medium);
      color: var(--text-primary); font-size: 14px; font-weight: 700; text-align: left;
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .custom-select-btn svg { width: 14px; height: 14px; color: var(--text-tertiary); transition: transform 0.24s var(--transition-curve); }
    .custom-select-wrapper.open .custom-select-btn svg { transform: rotate(180deg); }
    .custom-select-options {
      position: absolute; top: calc(100% + 8px); left: 0; right: 0; z-index: 50;
      background: var(--fill-primary); border: 1px solid var(--separator);
      border-radius: var(--radius-medium); max-height: 256px; overflow-y: auto; padding: 6px 0;
      opacity: 0; transform: translateY(-6px); transition: opacity .24s var(--transition-curve), transform .24s var(--transition-curve);
      pointer-events: none;
    }
    .custom-select-wrapper.open .custom-select-options { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .custom-select-option { padding: 10px 14px; font-size: 14px; cursor: pointer; color: var(--text-secondary); }
    .custom-select-option:hover, .custom-select-option.selected { background: var(--fill-secondary); color: var(--text-primary); }

    /* SEARCH INPUT */
    .search-wrap { position: relative; }
    .search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--text-tertiary); }
    #search {
      width: 100%; height: 48px; padding: 0 14px 0 40px;
      background: var(--fill-primary); border: 1px solid var(--separator); border-radius: var(--radius-medium);
      color: var(--text-primary); font-size: 15px; outline: none;
    }
    #search:focus, .custom-select-btn:focus, .icon-btn.burger:focus {
      border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(var(--primary-blue-rgb), 0.18);
      outline: none;
    }

    #countInfo { color: var(--text-secondary); font-size: 14px; font-weight: 700; margin-top: 6px; text-align: right; }
    .list-container { display: flex; flex-direction: column; gap: 8px; }
    .list-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--fill-primary); border: 1px solid var(--separator); border-radius: var(--radius-medium);
      text-decoration: none; color: inherit;
      transition: transform 0.18s var(--transition-curve), background-color 0.18s ease, border-color 0.18s ease;
    }
    .list-item:hover { transform: translateY(-2px); background-color: var(--fill-secondary); border-color: var(--fill-tertiary); }
    .list-item .title { font-size: 15px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.01em; }
    .list-item .price { font-size: 15px; font-weight: 800; color: var(--primary-blue); }
    .empty, .err {
      border: 1px dashed var(--separator); border-radius: var(--radius-large);
      padding: 56px; text-align: center; color: var(--text-secondary); font-size: 16px;
    }

    /* Tombol burger kecil dan flat */
    .icon-btn.burger {
      width: 44px; height: 44px;
      border: 1px solid var(--separator);
      border-radius: var(--radius-medium);
      background: var(--fill-primary);
      display: grid; place-content: center;
      cursor: pointer;
      transition: border-color .2s ease, background .2s ease, transform .18s ease;
    }
    .icon-btn.burger:hover { background: var(--fill-secondary); transform: translateY(-1px); }
    .icon-btn.burger span {
      display: block; width: 18px; height: 1.6px; background: var(--text-secondary);
      border-radius: 1px; margin: 3.3px 0;
      transition: transform .25s var(--transition-curve), opacity .25s var(--transition-curve);
    }
    .icon-btn.burger.active span:nth-child(1){ transform: translateY(4.9px) rotate(45deg); }
    .icon-btn.burger.active span:nth-child(2){ opacity: 0; transform: scaleX(0); }
    .icon-btn.burger.active span:nth-child(3){ transform: translateY(-4.9px) rotate(-45deg); }

    /* === VIEW: PRE-ORDER === */
    #viewPreorder { display: none; }
    .po-head {
      position: sticky; top: 0; z-index: 10;
      background: rgba(245, 245, 247, 0.72);
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--separator);
      padding: 12px 0; margin-bottom: 18px;
    }
    @media (prefers-color-scheme: dark) { .po-head { background: rgba(0, 0, 0, 0.62); } }
    #viewPreorder .controls {
      display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; max-width: var(--maxw); margin: 0 auto; padding: 0 20px;
    }
    @media (max-width: 768px) { #viewPreorder .controls { grid-template-columns: 1fr; } }
    #viewPreorder .search-input, #viewPreorder .filter-select {
      width: 100%; height: 48px; padding: 0 14px; font-size: 15px; background: var(--fill-primary);
      border: 1px solid var(--separator); border-radius: var(--radius-medium); color: var(--text-primary); outline: none;
      appearance: none;
    }
    #viewPreorder .filter-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2386868b'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center; background-size: 18px;
    }
    #viewPreorder .search-input:focus, #viewPreorder .filter-select:focus {
      border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(var(--primary-blue-rgb), 0.18);
    }
    #viewPreorder .meta { max-width: var(--maxw); margin: 10px auto 0; padding: 0 20px; font-size: 13px; color: var(--text-secondary); font-weight: 700; }

    #viewPreorder .card-grid { display: flex; flex-direction: column; gap: 12px; }
    #viewPreorder .card {
      background: var(--fill-primary); border: 1px solid var(--separator); border-radius: var(--radius-large); padding: 18px;
      transition: background .18s var(--transition-curve), border-color .18s var(--transition-curve), transform .18s var(--transition-curve);
    }
    #viewPreorder .card.clickable { cursor: pointer; }
    #viewPreorder .card.clickable:hover { transform: translateY(-2px); background: var(--fill-secondary); border-color: var(--fill-tertiary); }
    #viewPreorder .card-header { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start; }
    #viewPreorder .card-name { font-size: 16px; font-weight: 800; letter-spacing: -0.01em; }
    #viewPreorder .card-product { font-size: 14px; color: var(--text-secondary); }
    #viewPreorder .card-date { font-size: 12px; color: var(--text-tertiary); margin-top: 8px; grid-column: 1 / -1; }

    /* Status badge super flat */
    #viewPreorder .status-badge {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 9999px;
      font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: .04em; border: 1px solid transparent;
    }
    #viewPreorder .status-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
    #viewPreorder .status-badge.success { color: #166534; background-color: #ecfdf5; border-color: #d1fae5; }
    #viewPreorder .status-badge.success::before { background-color: #22c55e; }
    #viewPreorder .status-badge.progress { color: #1e3a8a; background-color: #eff6ff; border-color: #dbeafe; }
    #viewPreorder .status-badge.progress::before { background-color: #3b82f6; }
    #viewPreorder .status-badge.pending { color: #854d0e; background-color: #fefce8; border-color: #fde68a; }
    #viewPreorder .status-badge.pending::before { background-color: #f59e0b; }
    #viewPreorder .status-badge.failed  { color: #991b1b; background-color: #fef2f2; border-color: #fecaca; }
    #viewPreorder .status-badge.failed::before { background-color: #ef4444; }

    #viewPreorder .card-details { max-height: 0; overflow: hidden; opacity: 0; transition: max-height .35s var(--transition-curve), opacity .25s var(--transition-curve), margin-top .25s var(--transition-curve), padding-top .25s var(--transition-curve); margin-top: 0; }
    #viewPreorder .card.expanded .card-details { max-height: 520px; opacity: 1; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--separator); }
    #viewPreorder .details-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; }
    #viewPreorder .detail-label { font-size: 12px; font-weight: 800; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: .04em; }
    #viewPreorder .detail-value { font-size: 14px; font-weight: 800; letter-spacing: -0.01em; }

    #viewPreorder .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 24px; }
    #viewPreorder .pagination-btn {
      padding: 0 18px; height: 42px; background: var(--fill-secondary); border: 1px solid var(--separator); border-radius: var(--radius-small);
      font-size: 14px; font-weight: 800; color: var(--text-primary); cursor: pointer; transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    #viewPreorder .pagination-btn:hover:not(:disabled) { transform: translateY(-1px); background: var(--fill-tertiary); border-color: var(--fill-tertiary); }
    #viewPreorder .pagination-btn:disabled { opacity:.55; cursor:not-allowed; }

    #viewPreorder .loading, #viewPreorder .empty-state { text-align:center; padding:56px 12px; }
    #viewPreorder .spinner { width: 22px; height: 22px; border: 2px solid var(--fill-tertiary); border-top: 2px solid var(--primary-blue); border-radius: 50%; animation:spin 1s linear infinite; margin:0 auto 12px; }
    @keyframes spin { 100% { transform:rotate(360deg) } }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <img src="logo.png" alt="PlayPal.ID Logo" class="logo">
      <h1>PlayPal.ID</h1>
      <p>Destinasi Utama Para Pecinta Game, Film &amp; Musik</p>
    </header>

    <!-- KATALOG -->
    <section id="viewCatalog" aria-label="Katalog">
      <div class="controls-katalog" aria-label="Kontrol Katalog">
        <!-- dropdown kategori (compact) -->
        <div class="custom-select-wrapper" id="custom-select-wrapper">
          <button class="custom-select-btn" id="custom-select-btn" aria-haspopup="listbox" aria-expanded="false">
            <span id="custom-select-value">Pilih Kategori</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <div class="custom-select-options" id="custom-select-options" role="listbox"></div>
        </div>

        <!-- burger di samping dropdown -->
        <button class="icon-btn burger" id="burger" aria-label="Menu" aria-expanded="false" type="button">
          <span></span><span></span><span></span>
        </button>

        <!-- flyout menu yang muncul dari burger (anchor ke controls-katalog) -->
        <nav class="menu" id="menu" aria-label="Menu tampilan">
          <button class="menu-btn" data-mode="katalog" type="button">Katalog</button>
          <button class="menu-btn" data-mode="preorder" type="button">Lacak Preâ€‘Order</button>
          <div class="menu-divider"></div>
          <button class="menu-btn" id="closeMenu" type="button">Tutup</button>
        </nav>

        <!-- search: full width baris kedua -->
        <div class="search-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.901l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"/></svg>
          <input id="search" type="search" placeholder="Cari item..." aria-label="Cari">
        </div>
      </div>

      <div id="countInfo"></div>
      <section id="list-container" class="list-container" aria-live="polite"></section>
      <section id="error" class="err" style="display:none"></section>
      <template id="itemTmpl">
        <a class="list-item" target="_blank" rel="noopener">
          <span class="title"></span>
          <span class="price"></span>
        </a>
      </template>
    </section>

    <!-- PRE-ORDER -->
    <section id="viewPreorder" aria-label="Pre-Order">
      <div class="po-head">
        <div class="controls" aria-label="Kontrol data">
          <input type="search" class="search-input" id="poSearch" placeholder="Cari nama / ID Server / item..." />
          <select class="filter-select" id="poStatus" aria-label="Filter status">
            <option value="all">Semua Status</option>
            <option value="success">Success</option>
            <option value="progress">Progress</option>
            <option value="pending">Pending</option>
            <option value="failed">Gagal</option>
          </select>
          <select class="filter-select" id="poSheet" aria-label="Pilih kategori pesanan">
            <option value="0">Starlight Member</option>
            <option value="1">Pesanan Umum</option>
          </select>
        </div>
        <div class="meta" id="poTotal"></div>
      </div>
      <div class="container">
        <main class="card-grid" id="poList" aria-live="polite"></main>
        <nav class="pagination" aria-label="Pagination">
          <button class="pagination-btn" id="poPrev" disabled>Sebelumnya</button>
          <button class="pagination-btn" id="poNext" disabled>Selanjutnya</button>
        </nav>
      </div>
    </section>
  </main>

  <script>
    (function() {
      // ========= GLOBAL CONFIG =========
      const SHEET_ID = '1B0XPR4uSvRzy9LfzWDjNjwAyMZVtJs6_Kk_r2fh7dTw';
      const SHEETS = {
        katalog: { name: 'Sheet3' },
        preorder: { name1: 'Sheet1', name2: 'Sheet2' }
      };
      const WA_NUMBER = '6285877001999';
      const WA_GREETING = '*Detail pesanan:*';

      let DATA = [], CATS = [], activeCat = '', query = '';

      // ========= ELEMENTS =========
      const viewCatalog = document.getElementById('viewCatalog');
      const viewPreorder = document.getElementById('viewPreorder');

      const listEl = document.getElementById('list-container');
      const searchEl = document.getElementById('search');
      const countInfoEl = document.getElementById('countInfo');
      const itemTmpl = document.getElementById('itemTmpl');
      const errBox = document.getElementById('error');

      // Custom Select Elements
      const customSelectWrapper = document.getElementById('custom-select-wrapper');
      const customSelectBtn = document.getElementById('custom-select-btn');
      const customSelectValue = document.getElementById('custom-select-value');
      const customSelectOptions = document.getElementById('custom-select-options');

      // Burger & Menu
      const burger = document.getElementById('burger');
      const menu = document.getElementById('menu');

      // ========= MENU (burger) =========
      function setMenuOpen(open) {
        burger.classList.toggle('active', open);
        menu.classList.toggle('open', open);
        burger.setAttribute('aria-expanded', open);
      }
      burger.addEventListener('click', () => setMenuOpen(!burger.classList.contains('active')));
      document.getElementById('closeMenu').addEventListener('click', () => setMenuOpen(false));
      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && !burger.contains(e.target)) setMenuOpen(false);
      });

      // ========= MODE SWITCH =========
      let MODE = 'katalog';
      function setMode(next) {
        MODE = next;
        viewCatalog.style.display = MODE === 'katalog' ? 'block' : 'none';
        viewPreorder.style.display = MODE === 'preorder' ? 'block' : 'none';
        setMenuOpen(false);
        if (MODE === 'preorder' && !poState.initialized) poInit();
        // Scroll ke atas ketika ganti mode
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      // Tombol pada flyout menu
      menu.querySelectorAll('.menu-btn[data-mode]').forEach(btn => {
        btn.addEventListener('click', () => setMode(btn.getAttribute('data-mode')));
      });

      // ========= UTILS =========
      const prettyLabel = (raw) => String(raw || '').trim().replace(/\s+/g, ' ');
      const toIDR = v => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(v);
      const sheetUrlJSON = (sheetName) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
      const sheetUrlCSV = (sheetIndex0) => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet${sheetIndex0 + 1}`;

      // ========= KATALOG VIEW =========
      function parseGVizPairs(jsonText) {
        const m = jsonText.match(/\{.*\}/s);
        if (!m) throw new Error('Invalid GViz response.');
        const obj = JSON.parse(m[0]);
        const table = obj.table || {}, rows = table.rows || [], cols = table.cols || [];
        const pairs = Array.from({ length: Math.floor(cols.length / 2) }, (_, i) => ({
          iTitle: i * 2, iPrice: i * 2 + 1, label: cols[i * 2]?.label || ''
        })).filter(p => p.label && cols[p.iPrice]);

        const out = [];
        for (const r of rows) {
          const c = r.c || [];
          for (const p of pairs) {
            const title = String(c[p.iTitle]?.v || '').trim();
            const priceRaw = c[p.iPrice]?.v;
            const price = (priceRaw != null && priceRaw !== '') ? Number(priceRaw) : NaN;
            if (title && !isNaN(price)) {
              out.push({ catKey: p.label, catLabel: prettyLabel(p.label), title, price });
            }
          }
        }
        return out;
      }

      function toggleCustomSelect(open) {
        const isOpen = typeof open === 'boolean' ? open : !customSelectWrapper.classList.contains('open');
        customSelectWrapper.classList.toggle('open', isOpen);
        customSelectBtn.setAttribute('aria-expanded', isOpen);
      }
      customSelectBtn.addEventListener('click', () => toggleCustomSelect());
      document.addEventListener('click', (e) => {
        if (!customSelectWrapper.contains(e.target) && !customSelectBtn.contains(e.target)) toggleCustomSelect(false);
      });

      function buildGameSelect() {
        const map = new Map();
        DATA.forEach(it => { if (!map.has(it.catKey)) map.set(it.catKey, it.catLabel) });
        CATS = [...map].map(([key, label]) => ({ key, label }));

        customSelectOptions.innerHTML = '';
        CATS.forEach((c, index) => {
          const optionEl = document.createElement('div');
          optionEl.className = 'custom-select-option';
          optionEl.textContent = c.label;
          optionEl.dataset.value = c.key;
          optionEl.setAttribute('role', 'option');
          if (index === 0) optionEl.classList.add('selected');
          optionEl.addEventListener('click', () => {
            activeCat = c.key;
            customSelectValue.textContent = c.label;
            document.querySelector('.custom-select-option.selected')?.classList.remove('selected');
            optionEl.classList.add('selected');
            toggleCustomSelect(false);
            renderList();
          });
          customSelectOptions.appendChild(optionEl);
        });

        if (CATS.length > 0) {
          activeCat = CATS[0].key;
          customSelectValue.textContent = CATS[0].label;
        } else {
          customSelectValue.textContent = "Data tidak tersedia";
        }
      }

      function renderList() {
        const items = DATA.filter(x => x.catKey === activeCat &&
          (query === '' || x.title.toLowerCase().includes(query) || String(x.price).includes(query))
        );
        listEl.innerHTML = '';
        if (items.length === 0) {
          listEl.innerHTML = `<div class="empty">Tidak ada hasil ditemukan.</div>`;
          countInfoEl.textContent = '';
          return;
        }
        const fragment = document.createDocumentFragment();
        for (const it of items) {
          const clone = itemTmpl.content.cloneNode(true);
          const link = clone.querySelector('.list-item');
          link.querySelector('.title').textContent = it.title;
          link.querySelector('.price').textContent = toIDR(it.price);
          const text = `${WA_GREETING}\nâ€º Tipe: Katalog\nâ€º Game: ${it.catLabel}\nâ€º Item: ${it.title}\nâ€º Harga: ${toIDR(it.price)}`;
          link.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
          fragment.appendChild(clone);
        }
        listEl.appendChild(fragment);
        countInfoEl.textContent = `${items.length} item ditemukan`;
      }

      let debounceTimer;
      searchEl.addEventListener('input', e => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => { query = e.target.value.trim().toLowerCase(); renderList(); }, 200);
      });

      async function loadCatalog() {
        try {
          errBox.style.display = 'none';
          listEl.innerHTML = `<div class="empty">Memuat katalog...</div>`;
          const res = await fetch(sheetUrlJSON(SHEETS.katalog.name), { cache: 'no-store' });
          if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
          const txt = await res.text();
          DATA = parseGVizPairs(txt);
          if (DATA.length === 0) throw new Error('Data kosong atau format kolom tidak sesuai.');
          buildGameSelect();
          renderList();
        } catch (err) {
          console.error("Fetch Katalog failed:", err);
          errBox.style.display = 'block';
          errBox.textContent = `Gagal memuat data: ${err.message}`;
        }
      }

      // ========= PRE-ORDER VIEW =========
      const poSearch = document.getElementById('poSearch');
      const poStatus = document.getElementById('poStatus');
      const poSheet = document.getElementById('poSheet');
      const poList = document.getElementById('poList');
      const poPrev = document.getElementById('poPrev');
      const poNext = document.getElementById('poNext');
      const poTotal = document.getElementById('poTotal');

      const poState = { initialized: false, allData: [], currentPage: 1, perPage: 15 };

      // PRIVASI: kosongkan ID Gift & Nomor Telepon (berbagai variasi penamaan)
      const PRIVACY_KEYS = [
        'id gift','gift id','gift',
        'nomor','no','telepon','no telepon','no. telepon','nomor telepon',
        'phone','hp','whatsapp','wa','no wa','no. wa'
      ];
      const isPrivacyKey = (k) => {
        const s = String(k || '').trim().toLowerCase();
        return PRIVACY_KEYS.some(key => s === key || s.includes(key));
      };
      function scrubRecord(rec) {
        const out = { ...rec };
        for (const k of Object.keys(out)) if (isPrivacyKey(k)) out[k] = '';
        return out;
      }

      const normalizeStatus = (raw) => {
        const s = String(raw || '').trim().toLowerCase();
        if (['success','selesai','berhasil','done'].includes(s)) return 'success';
        if (['progress','proses','diproses','processing'].includes(s)) return 'progress';
        if (['failed','gagal','dibatalkan','cancel','error'].includes(s)) return 'failed';
        return 'pending';
      };

      const poFilterData = () => {
        const q = poSearch.value.trim().toLowerCase();
        const status = poStatus.value;
        return poState.allData.filter(item => {
          const name = (item['Nickname'] || '').toLowerCase();
          const idServer = (item['ID Server'] || '').toLowerCase();
          const product = (item['Produk / Item'] || item['Item'] || '').toLowerCase();
          const match = name.includes(q) || idServer.includes(q) || product.includes(q);
          const s = normalizeStatus(item['Status']);
          return match && (status === 'all' || s === status);
        });
      };

      const poUpdatePagination = (cur, total) => {
        poPrev.disabled = cur <= 1;
        poNext.disabled = cur >= total;
      };

      const poRender = () => {
        const filtered = poFilterData();
        const totalItems = poState.allData.length;
        poTotal.textContent = `${totalItems} total pesanan${filtered.length !== totalItems ? `, ${filtered.length} ditemukan` : ''}`;

        const totalPages = Math.max(1, Math.ceil(filtered.length / poState.perPage));
        poState.currentPage = Math.min(Math.max(1, poState.currentPage), totalPages);
        const start = (poState.currentPage - 1) * poState.perPage;
        const pageData = filtered.slice(start, start + poState.perPage);

        poList.innerHTML = '';
        if (pageData.length === 0) {
          poList.innerHTML = `<div class="empty-state"><p>Tidak Ada Hasil Ditemukan</p></div>`;
          poUpdatePagination(0, 0);
          return;
        }

        const frag = document.createDocumentFragment();
        pageData.forEach(item => {
          const clean = scrubRecord(item); // pastikan bersih

          let statusClass = normalizeStatus(clean['Status']);
          const name = clean['Nickname'] || clean['ID Server'] || 'Tanpa Nama';
          const product = clean['Produk / Item'] || clean['Item'] || 'N/A';
          const estDelivery = clean['Est. Pengiriman'] ? `${clean['Est. Pengiriman']} 20:00 WIB` : '';

          const HIDE_KEYS = new Set([
            'Nickname','ID Server','Produk / Item','Item','Status','Est. Pengiriman',
            ...Object.keys(clean).filter(isPrivacyKey)
          ]);

          const detailsHtml = Object.entries(clean)
            .filter(([k,v]) => v && !HIDE_KEYS.has(k))
            .map(([k,v]) => `
              <div class="detail-item">
                <div class="detail-label">${k}</div>
                <div class="detail-value">${v}</div>
              </div>
            `).join('');

          const card = document.createElement('article');
          card.className = `card ${detailsHtml ? 'clickable' : ''}`;
          card.innerHTML = `
            <div class="card-header">
              <div>
                <div class="card-name">${name}</div>
                <div class="card-product">${product}</div>
              </div>
              <div class="status-badge ${statusClass}">${(clean['Status'] || 'Pending').toUpperCase()}</div>
            </div>
            ${estDelivery ? `<div class="card-date">Estimasi Pengiriman: ${estDelivery}</div>` : ''}
            ${detailsHtml ? `<div class="card-details"><div class="details-grid">${detailsHtml}</div></div>` : ''}
          `;
          if (detailsHtml) card.addEventListener('click', () => card.classList.toggle('expanded'));
          frag.appendChild(card);
        });

        poList.appendChild(frag);
        poUpdatePagination(poState.currentPage, totalPages);
      };

      const poSortByStatus = (data) => {
        const order = { 'progress': 1, 'pending': 2, 'success': 3, 'failed': 4 };
        return data.sort((a, b) => order[normalizeStatus(a.Status)] - order[normalizeStatus(b.Status)]);
      };

      async function poFetch(sheetIndex0) {
        poTotal.textContent = 'Memuat data...';
        poList.innerHTML = `<div class="loading"><div class="spinner"></div><p>Memuat data...</p></div>`;
        try {
          const res = await fetch(sheetUrlCSV(sheetIndex0), { cache: 'no-store' });
          if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
          const text = await res.text();

          const rows = text.trim().split('\n')
            .map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim()));

          if (rows.length < 1) { poState.allData = []; return; }

          if (sheetIndex0 === 0) {
            const headers = rows.shift();
            const mapped = rows
              .map(row => Object.fromEntries(row.map((val, i) => [headers[i] || `col_${i+1}`, val])))
              .filter(item => item[headers[0]]);
            poState.allData = poSortByStatus(mapped.map(scrubRecord));
          } else {
            const bodyRows = rows[0]?.length === 3 && ['id server','item','status'].includes(rows[0][0].toLowerCase())
              ? rows.slice(1) : rows;
            const mapped = bodyRows
              .map(r => ({ 'ID Server': r[0] || '', 'Item': r[1] || '', 'Status': r[2] || '' }))
              .filter(item => item['ID Server']);
            poState.allData = poSortByStatus(mapped.map(scrubRecord));
          }
        } catch (e) {
          poState.allData = [];
          poTotal.textContent = 'Gagal memuat data.';
          console.error("Fetch Pre-Order failed:", e);
        } finally {
          poState.currentPage = 1;
          poRender();
        }
      }

      function poInit() {
        const poDebounced = () => { poState.currentPage = 1; poRender(); };
        poSearch.addEventListener('input', poDebounced);
        poStatus.addEventListener('change', poDebounced);
        poSheet.addEventListener('change', (e) => poFetch(parseInt(e.target.value, 10)));
        poPrev.addEventListener('click', () => { if (poState.currentPage > 1) { poState.currentPage--; poRender(); window.scrollTo({ top: 0, behavior: 'smooth' }); } });
        poNext.addEventListener('click', () => { poState.currentPage++; poRender(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
        poFetch(0);
        poState.initialized = true;
      }

      // Initial
      loadCatalog();
    })();
  </script>
</body>
</html>
