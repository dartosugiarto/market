<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlayPal.ID</title>
  <meta name="description" content="Destinasi Utama Para Pecinta Game, Film & Musik">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --text:#1f2937; --muted:#6b7280;
      --surface:#f3f3f3; --border:#e5e7eb; --surface-hover:#e9e9e9;
      --primary:#5C80BC; --primary-hover:#4a6b9a;
      --maxw:1100px; --radius:8px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#111827; --text:#f3f4f6; --muted:#9ca3af;
        --surface:#1f2937; --border:#374151; --surface-hover:#374151;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Inter',ui-sans-serif,-apple-system,system-ui,"Segoe UI",sans-serif;
      font-size:15px; line-height:1.5;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:var(--maxw); margin:0 auto; padding:32px 16px}

    /* HEADER */
    header{ position:relative; text-align:center; margin-bottom:16px; }
    .topbar{display:flex; align-items:center; justify-content:center; gap:12px}
    header .logo{ height:44px; width:auto; }
    header h1{ margin:6px 0 0; font-size:clamp(22px,4vw,28px); font-weight:800; }
    header p{ margin:4px 0 0; color:var(--muted); font-size:14px; }

    /* Burger Menu */
    .burger{
      position:absolute; top:16px; right:16px;
      width:28px; height:20px; cursor:pointer;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .burger span{ display:block; height:2px; width:100%; background:var(--text); border-radius:2px; transition:all .3s ease; }
    .burger.active span:nth-child(1){ transform:rotate(45deg) translate(5px,5px); }
    .burger.active span:nth-child(2){ opacity:0; }
    .burger.active span:nth-child(3){ transform:rotate(-45deg) translate(5px,-5px); }

    /* Dropdown Menu */
    .menu{
      position:absolute; top:48px; right:16px;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 4px 16px rgba(0,0,0,0.15);
      display:none; flex-direction:column;
      min-width:180px; overflow:hidden; z-index:20;
    }
    .menu .menu-btn{
      padding:12px 16px; border:0; background:transparent; text-align:left;
      color:var(--text); font-weight:600; font-size:14px; cursor:pointer;
      transition:background .2s ease;
    }
    .menu .menu-btn:hover{ background:var(--surface-hover); }
    .menu .menu-divider{ height:1px; background:var(--border); margin:4px 0; }

    /* ====== VIEW: KATALOG (Sheet3) ====== */
    #viewCatalog{ display:block; }
    .select-wrap{ position:relative; margin:20px 0; }
    .game-select{
      width:100%; padding:12px 16px; border:1px solid var(--border);
      background-color:var(--bg); color:var(--text); border-radius:var(--radius);
      font-size:15px; font-weight:600;
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 20 20'%3E%3Cpath d='M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center; background-size:20px;
    }
    .tools{display:flex; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search-wrap{position:relative; flex:1 1 260px;}
    .search-wrap svg{ position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; color:var(--muted); }
    .tools input[type="search"]{
      width:100%; padding:8px 12px 8px 38px; border:1px solid var(--border);
      background:var(--bg); color:var(--text); border-radius:var(--radius); font-size:14px;
    }
    .tools .info{color:var(--muted); font-size:13px; font-weight:500; padding-left:12px;}
    .list-container{ display:flex; flex-direction:column; gap:8px; }
    .list-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; background:var(--surface); border-radius:var(--radius);
      text-decoration:none; color:inherit; transition:background-color .2s ease;
    }
    .list-item:hover{ background-color:var(--surface-hover); }
    .list-item .title{ font-size:14px; font-weight:500; color:var(--text); }
    .list-item .price{ font-size:14px; font-weight:600; color:var(--primary); }
    .empty, .err{ border:1px dashed var(--border); border-radius:var(--radius); padding:40px; text-align:center; color:var(--muted); font-size:14px; }
    .err{ border:1px solid #ef4444; background:#fef2f2; color:#b91c1c; display:none }
    @media (prefers-color-scheme: dark){ .err{background:#2a0c0c; color:#fca5a5; border-color:#7f1d1d} }

    /* ====== VIEW: PRE-ORDER (Sheet1/2) ====== */
    #viewPreorder{ display:none; }
    #viewPreorder .po-head{
      position:sticky; top:0; z-index:10; background:rgba(255,255,255,.75);
      backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
      border-bottom:1px solid var(--border); padding:12px 0 10px;
    }
    @media (prefers-color-scheme: dark){
      #viewPreorder .po-head{ background:rgba(31,41,55,.75); border-bottom-color:var(--border); }
    }
    #viewPreorder .controls{ display:grid; grid-template-columns:2fr 1fr 1fr; gap:12px; max-width:1100px; margin:0 auto; padding:0 0 8px; }
    @media (max-width:768px){ #viewPreorder .controls{ grid-template-columns:1fr; } }
    #viewPreorder .search-input, #viewPreorder .filter-select{
      width:100%; height:46px; padding:0 14px; font-size:15px; background:var(--bg);
      border:1px solid var(--border); border-radius:12px; color:var(--text); outline:none;
    }
    #viewPreorder .search-input:focus, #viewPreorder .filter-select:focus{
      border-color:#3B82F6; box-shadow:0 0 0 3px rgba(59,130,246,.2);
    }
    #viewPreorder .meta{ max-width:1100px; margin:6px auto 0; padding:0 2px; font-size:13px; color:var(--muted); }

    #viewPreorder .container{ max-width:1100px; margin:0 auto; padding:24px 0; display:flex; flex-direction:column; gap:24px; }
    #viewPreorder .card-grid{ display:flex; flex-direction:column; gap:12px; }
    #viewPreorder .card{
      background:var(--bg); border:1px solid var(--border); border-radius:16px; padding:18px 20px;
      transition:all .3s ease; box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    #viewPreorder .card.clickable{ cursor:pointer; }
    #viewPreorder .card.clickable:hover{ transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,0,0,.06); }
    #viewPreorder .card-header{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:start; }
    #viewPreorder .card-name{ font-size:16px; font-weight:700; }
    #viewPreorder .card-product{ font-size:14px; color:var(--muted); }
    #viewPreorder .card-date{ font-size:12px; color:var(--muted); margin-top:8px; grid-column:1 / -1; }
    #viewPreorder .status-badge{ display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; font-size:11px; font-weight:700; text-transform:uppercase; border:1px solid transparent; }
    #viewPreorder .status-badge::before{ content:''; width:6px; height:6px; border-radius:50%; }
    #viewPreorder .status-badge.success{ color:#22C55E; background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.2); }
    #viewPreorder .status-badge.success::before{ background:#22C55E; }
    #viewPreorder .status-badge.progress{ color:#3B82F6; background:rgba(59,130,246,.1); border-color:rgba(59,130,246,.2); }
    #viewPreorder .status-badge.progress::before{ background:#3B82F6; }
    #viewPreorder .status-badge.pending{ color:#F59E0B; background:rgba(245,158,11,.1); border-color:rgba(245,158,11,.2); }
    #viewPreorder .status-badge.pending::before{ background:#F59E0B; }
    #viewPreorder .status-badge.failed{ color:#EF4444; background:rgba(239,68,68,.1); border-color:rgba(239,68,68,.2); }
    #viewPreorder .status-badge.failed::before{ background:#EF4444; }
    #viewPreorder .card-details{ max-height:0; overflow:hidden; opacity:0; transition:all .35s ease; margin-top:0; }
    #viewPreorder .card.expanded .card-details{ max-height:500px; opacity:1; margin-top:14px; padding-top:14px; border-top:1px solid var(--border); }
    #viewPreorder .details-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
    #viewPreorder .detail-label{ font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; }
    #viewPreorder .detail-value{ font-size:14px; font-weight:600; }
    #viewPreorder .pagination{ display:flex; justify-content:center; align-items:center; gap:10px; margin-top:12px; }
    #viewPreorder .pagination-btn{ padding:0 22px; height:42px; background:var(--bg); border:1px solid var(--border); border-radius:12px; font-size:14px; font-weight:600; color:var(--text); cursor:pointer; transition:all .2s ease; }
    #viewPreorder .pagination-btn:hover:not(:disabled){ background:#3B82F6; color:#fff; border-color:#3B82F6; transform:translateY(-1px); }
    #viewPreorder .pagination-btn:disabled{ opacity:.45; cursor:not-allowed; }
    #viewPreorder .loading, #viewPreorder .empty-state{ text-align:center; padding:48px 12px; }
    #viewPreorder .spinner{ width:22px; height:22px; border:2px solid var(--surface-hover); border-top:2px solid #3B82F6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 12px; }
    @keyframes spin{100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <div class="topbar">
        <img src="logo.png" alt="PlayPal.ID Logo" class="logo">
      </div>
      <h1>PlayPal.ID</h1>
      <p>Destinasi Utama Para Pecinta Game, Film &amp; Musik</p>

      <!-- Burger -->
      <div class="burger" id="burger" aria-label="Menu" aria-expanded="false" role="button" tabindex="0">
        <span></span><span></span><span></span>
      </div>
      <nav class="menu" id="menu" aria-label="Navigasi tampilan">
        <button class="menu-btn" data-mode="katalog" type="button">Katalog</button>
        <button class="menu-btn" data-mode="preorder" type="button">Pre-Order</button>
        <div class="menu-divider"></div>
        <button class="menu-btn" id="closeMenu" type="button">Tutup</button>
      </nav>
    </header>

    <!-- ====== VIEW: KATALOG ====== -->
    <section id="viewCatalog">
      <div class="select-wrap">
        <select id="game-select" class="game-select" aria-label="Pilih Kategori"></select>
      </div>

      <div class="tools">
        <div class="search-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.901l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"/></svg>
          <input id="search" type="search" placeholder="Cari item..." aria-label="Cari">
        </div>
        <span id="countInfo" class="info"></span>
      </div>

      <section id="list-container" class="list-container" aria-live="polite"></section>
      <section id="error" class="err"></section>

      <template id="itemTmpl">
        <a class="list-item" target="_blank" rel="noopener">
          <span class="title"></span>
          <span class="price"></span>
        </a>
      </template>
    </section>

    <!-- ====== VIEW: PRE-ORDER ====== -->
    <section id="viewPreorder" aria-label="Pre-Order">
      <div class="po-head">
        <div class="controls" aria-label="Kontrol data">
          <input type="search" class="search-input" id="poSearch" placeholder="Cari nama / ID Server / item..." />
          <select class="filter-select" id="poStatus" aria-label="Filter status">
            <option value="all">Semua Status</option>
            <option value="success">Success</option>
            <option value="progress">Progress</option>
            <option value="pending">Pending</option>
            <option value="failed">Gagal</option>
          </select>
          <select class="filter-select" id="poSheet" aria-label="Pilih kategori pesanan">
            <option value="0">Starlight Member</option>
            <option value="1">Pesanan Umum</option>
          </select>
        </div>
        <div class="meta" id="poTotal">Memuat total pesanan...</div>
      </div>

      <div class="container">
        <main class="card-grid" id="poList" aria-live="polite"></main>
        <nav class="pagination" aria-label="Pagination">
          <button class="pagination-btn" id="poPrev" disabled>Sebelumnya</button>
          <button class="pagination-btn" id="poNext" disabled>Selanjutnya</button>
        </nav>
      </div>
    </section>
  </main>

  <script>
    // ========= GLOBAL KONFIG =========
    const SHEET_ID = '1B0XPR4uSvRzy9LfzWDjNjwAyMZVtJs6_Kk_r2fh7dTw';
    const SHEETS = {
      katalog : { name:'Sheet3' }, // katalog normal
      preorder: { name1:'Sheet1', name2:'Sheet2' } // Pre-Order: hanya Sheet1 & Sheet2
    };
    const WA_NUMBER   = '6285877001999';
    const WA_GREETING = '*Detail pesanan:*';

    // ========= MENU (burger) =========
    const burger = document.getElementById('burger');
    const menu = document.getElementById('menu');
    function setMenuOpen(open){
      burger.classList.toggle('active', open);
      menu.style.display = open ? 'flex' : 'none';
      burger.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    burger.addEventListener('click', () => setMenuOpen(menu.style.display !== 'flex'));
    document.getElementById('closeMenu').addEventListener('click', () => setMenuOpen(false));
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !burger.contains(e.target)) setMenuOpen(false);
    });

    // ========= MODE SWITCH =========
    const viewCatalog  = document.getElementById('viewCatalog');
    const viewPreorder = document.getElementById('viewPreorder');
    let MODE = 'katalog'; // 'katalog' | 'preorder'
    function setMode(next){
      MODE = next;
      viewCatalog.style.display  = MODE === 'katalog'  ? 'block' : 'none';
      viewPreorder.style.display = MODE === 'preorder' ? 'block' : 'none';
      setMenuOpen(false);
      if (MODE === 'preorder' && poState.initialized === false){ poInit(); }
    }
    menu.querySelectorAll('.menu-btn[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => setMode(btn.getAttribute('data-mode')));
    });

    // ========= UTIL UMUM =========
    function prettyLabel(raw){ return String(raw||'').trim().replace(/\s+/g,' '); }
    const toIDR = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);
    const sheetUrlJSON = (sheetName) =>
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
    const sheetUrlCSV = (sheetIndex0) =>
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet${sheetIndex0+1}`;

    // ========= VIEW KATALOG (GViz JSON pasangan kolom) =========
    const gameSelectEl = document.getElementById('game-select');
    const listEl = document.getElementById('list-container');
    const searchEl = document.getElementById('search');
    const countInfoEl = document.getElementById('countInfo');
    const itemTmpl = document.getElementById('itemTmpl');
    const errBox = document.getElementById('error');

    let DATA = [], CATS = [], activeCat = '', query = '';

    function parseGVizPairs(jsonText){
      const m = jsonText.match(/\{.*\}/s);
      if(!m) throw new Error('Response GViz tidak valid.');
      const obj = JSON.parse(m[0]);
      const table = obj.table || {}, rows = table.rows || [], cols = table.cols || [];
      const pairs = [];
      for(let i=0; i<cols.length; i+=2){
        const label = cols[i]?.label || '';
        if(label && cols[i+1]) pairs.push({ iTitle:i, iPrice:i+1, label });
      }
      const out = [];
      for(const r of rows){
        const c = r.c || [];
        for(const p of pairs){
          const title = c[p.iTitle]?.v != null ? String(c[p.iTitle].v).trim() : '';
          const priceRaw = c[p.iPrice]?.v;
          const price = priceRaw!=null && priceRaw!=='' ? Number(priceRaw) : NaN;
          if(title && !isNaN(price)){
            out.push({ catKey:p.label, catLabel:prettyLabel(p.label), title, price });
          }
        }
      }
      return out;
    }

    function buildGameSelect(){
      const map = new Map();
      DATA.forEach(it => { if(!map.has(it.catKey)) map.set(it.catKey, it.catLabel) });
      CATS = [...map].map(([key,label]) => ({key,label}));
      gameSelectEl.innerHTML = '';
      CATS.forEach(c => {
        const option = document.createElement('option');
        option.value = c.key;
        option.textContent = c.label;
        gameSelectEl.appendChild(option);
      });
      activeCat = CATS[0]?.key || '';
    }

    function renderList(){
      const items = DATA.filter(x => x.catKey === activeCat &&
        (query === '' || x.title.toLowerCase().includes(query) || String(x.price).includes(query))
      );
      listEl.innerHTML = '';
      if(items.length === 0){
        listEl.innerHTML = `<div class="empty">Tidak ada hasil ditemukan.</div>`;
        countInfoEl.textContent = '';
        return;
      }
      const fragment = document.createDocumentFragment();
      for(const it of items){
        const clone = itemTmpl.content.cloneNode(true);
        const link = clone.querySelector('.list-item');
        link.querySelector('.title').textContent = it.title;
        link.querySelector('.price').textContent = toIDR(it.price);
        const text = `${WA_GREETING}\n› Tipe: Katalog\n› Game: ${it.catLabel}\n› Item: ${it.title}\n› Harga: ${toIDR(it.price)}`;
        link.href = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
        fragment.appendChild(clone);
      }
      listEl.appendChild(fragment);
      countInfoEl.textContent = `${items.length} item`;
    }

    gameSelectEl.addEventListener('change', e => { activeCat = e.target.value; renderList(); });
    let debounceTimer;
    searchEl.addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => { query = e.target.value.trim().toLowerCase(); renderList(); }, 150);
    });

    async function loadCatalog(){
      try{
        errBox.style.display = 'none';
        const res = await fetch(sheetUrlJSON(SHEETS.katalog.name), {cache:'no-store'});
        const txt = await res.text();
        DATA = parseGVizPairs(txt);
        if(DATA.length === 0) throw new Error('Data kosong atau format kolom tidak sesuai.');
        buildGameSelect();
        renderList();
      }catch(err){
        errBox.style.display = 'block';
        errBox.textContent = `Gagal memuat data: ${err.message}`;
      }
    }
    loadCatalog();

    // ========= VIEW PRE-ORDER (Sheet1 & Sheet2) =========
    const poRoot   = document.getElementById('viewPreorder');
    const poSearch = document.getElementById('poSearch');
    const poStatus = document.getElementById('poStatus');
    const poSheet  = document.getElementById('poSheet');
    const poList   = document.getElementById('poList');
    const poPrev   = document.getElementById('poPrev');
    const poNext   = document.getElementById('poNext');
    const poTotal  = document.getElementById('poTotal');

    const poState = {
      initialized:false,
      allData:[],
      currentPage:1,
      perPage:15
    };

    // normalisasi status ke {success,progress,pending,failed}
    function normalizeStatus(raw){
      let s = String(raw||'').trim().toLowerCase();
      if(s === 'gagal') s = 'failed';
      if(s === 'selesai' || s === 'berhasil' || s === 'done') s = 'success';
      if(s === 'proses' || s === 'diproses' || s === 'processing') s = 'progress';
      return s;
    }

    function poFilterData(){
      const q = poSearch.value.trim().toLowerCase();
      const status = poStatus.value;
      return poState.allData.filter(item => {
        // cari di Nickname (Sheet1), ID Server (Sheet2), dan Produk / Item
        const name = (item['Nickname'] || '').toLowerCase();
        const idServer = (item['ID Server'] || '').toLowerCase();
        const product = (item['Produk / Item'] || '').toLowerCase();
        const match = name.includes(q) || idServer.includes(q) || product.includes(q);
        const s = normalizeStatus(item['Status']);
        return match && (status === 'all' || s === status);
      });
    }

    function poUpdatePagination(cur,total){
      poPrev.disabled = cur <= 1;
      poNext.disabled = cur >= total;
    }

    function poRender(){
      const filtered = poFilterData();
      poTotal.textContent = `Total Pesanan: ${poState.allData.length}`;
      const totalPages = Math.max(1, Math.ceil(filtered.length / poState.perPage));
      poState.currentPage = Math.min(Math.max(1, poState.currentPage), totalPages);
      const start = (poState.currentPage - 1) * poState.perPage;
      const pageData = filtered.slice(start, start + poState.perPage);

      poList.innerHTML = '';
      if(pageData.length === 0){
        poList.innerHTML = `<div class="empty-state"><p>Tidak Ada Hasil</p></div>`;
        poUpdatePagination(0,0);
        return;
      }

      const frag = document.createDocumentFragment();
      pageData.forEach(item => {
        let statusClass = normalizeStatus(item['Status']) || 'failed';

        // Tentukan tampilan judul: pakai Nickname (Sheet1) atau ID Server (Sheet2)
        const name = item['Nickname'] || item['ID Server'] || 'Tanpa Nama';
        const product = item['Produk / Item'] || item['Item'] || 'N/A';

        // Estimasi kirim jika ada (Sheet1), opsional
        const estDelivery = item['Est. Pengiriman'] ? `${item['Est. Pengiriman']} 20:00 WIB` : '';

        // Susun detail selain field utama
        const hiddenKeys = new Set([
          'Nickname','ID Server','Produk / Item','Item','Status','Est. Pengiriman'
        ]);
        const detailsHtml = Object.entries(item)
          .filter(([k,v]) => v && !hiddenKeys.has(k))
          .map(([k,v]) => `
            <div class="detail-item">
              <div class="detail-label">${k}</div>
              <div class="detail-value">${v}</div>
            </div>
          `).join('');

        const card = document.createElement('article');
        card.className = `card ${detailsHtml ? 'clickable' : ''}`;
        card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="card-name">${name}</div>
              <div class="card-product">${product}</div>
            </div>
            <div class="status-badge ${statusClass}">${(item['Status'] || 'Gagal').toUpperCase()}</div>
          </div>
          ${estDelivery ? `<div class="card-date">Estimasi: ${estDelivery}</div>` : ''}
          ${detailsHtml ? `<div class="card-details"><div class="details-grid">${detailsHtml}</div></div>` : ''}
        `;
        if(detailsHtml){
          card.addEventListener('click', () => card.classList.toggle('expanded'));
        }
        frag.appendChild(card);
      });

      poList.appendChild(frag);
      poUpdatePagination(poState.currentPage, totalPages);
    }

    function poSortByStatus(data){
      const order = { 'progress':1, 'pending':2, 'success':3 };
      return data.sort((a,b) => {
        const sa = normalizeStatus(a.Status);
        const sb = normalizeStatus(b.Status);
        return (order[sa] || 4) - (order[sb] || 4);
      });
    }

    async function poFetch(sheetIndex0){
      poTotal.textContent = 'Memuat data...';
      poList.innerHTML = `<div class="loading"><div class="spinner"></div><p>Memuat data...</p></div>`;
      const url = sheetUrlCSV(sheetIndex0);
      try{
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.trim().split('\n')
          .map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim()));

        if(rows.length < 1){ poState.allData = []; poRender(); return; }

        if(sheetIndex0 === 0){
          // SHEET1: gunakan header baris pertama apa adanya
          const headers = rows.shift();
          const raw = rows.map(row => Object.fromEntries(row.map((val,i) => [headers[i] || `col_${i+1}`, val])));
          poState.allData = poSortByStatus(raw);
        }else{
          // SHEET2: format A|B|C (ID Server | Item | Status) TANPA header
          // Jika ternyata baris pertama berisi header, tetap aman karena kita map HARDCODE by index.
          const bodyRows = rows[0]?.length === 3 && ['id server','item','status'].includes(rows[0][0].toLowerCase())
            ? rows.slice(1) : rows;
          const mapped = bodyRows.map(r => ({
            'ID Server': r[0] || '',
            'Item': r[1] || '',
            'Status': r[2] || ''
          }));
          poState.allData = poSortByStatus(mapped);
        }
      }catch(e){
        poState.allData = [];
        poTotal.textContent = 'Gagal memuat data';
      }finally{
        poState.currentPage = 1;
        poRender();
      }
    }

    function poInit(){
      // events
      poSearch.addEventListener('input', () => { poState.currentPage = 1; poRender(); });
      poStatus.addEventListener('change', () => { poState.currentPage = 1; poRender(); });
      poSheet.addEventListener('change', (e) => poFetch(parseInt(e.target.value,10)));
      poPrev.addEventListener('click', () => { if(poState.currentPage>1){ poState.currentPage--; poRender(); window.scrollTo({top:0,behavior:'smooth'}); } });
      poNext.addEventListener('click', () => { poState.currentPage++; poRender(); window.scrollTo({top:0,behavior:'smooth'}); });

      // default: Starlight Member (Sheet1, index 0)
      poFetch(0);
      poState.initialized = true;
    }
  </script>
</body>
</html>
